apiVersion: apps/v1
kind: Deployment
metadata:
  name: ingest-api-deployment
  namespace: nyro-develop
  labels:
    app: ingest-api
spec:
  replicas: 1 # Puedes aumentar si la API recibe muchas peticiones simultáneas
  selector:
    matchLabels:
      app: ingest-api
  template:
    metadata:
      labels:
        app: ingest-api
    spec:
      containers:
        - name: ingest-api
          # Asegúrate que la imagen es la correcta y está actualizada
          image: ghcr.io/dev-nyro/ingest-service:develop-8bfdc44
          imagePullPolicy: Always # O IfNotPresent
          ports:
            - name: http
              containerPort: 8000 # Puerto que expone Gunicorn/Uvicorn
              protocol: TCP
          command: ["gunicorn"]
          args: [
              "-k", "uvicorn.workers.UvicornWorker",
              "-w", "4",                             # Número de workers (ajustar según CPU/memoria disponible)
              "-b", "0.0.0.0:8000",
              "-t", "120",                           # Timeout extendido
              "--log-level", "info",                 # Nivel de log para Gunicorn/Uvicorn
              "app.main:app"
            ]
          envFrom:
            - configMapRef:
                name: ingest-service-config
            - secretRef:
                name: ingest-service-secrets
          # ***** Recursos - Mantener como estaban (sin cambios específicos para GCS) *****
          resources:
            requests:
              cpu: "250m"
              memory: "512Mi"
            limits:
              cpu: "1500m"
              memory: "2Gi"
          # Probes eliminados según solicitud previa
      # --- GCS Authentication: Not directly configured here ---
      # Assumes Workload Identity is configured for the service account running this pod, OR
      # GOOGLE_APPLICATION_CREDENTIALS env var is set via secrets/volumeMounts if using key files.
      # serviceAccountName: your-ksa-with-workload-identity # Example if using WI

      # imagePullSecrets: # Descomentar si usas registro privado
      # - name: your-registry-secret